# Deploy to Production
# =====================
# Deploys the application to production server via SSH.
#
# Triggers:
#   - Manual trigger (workflow_dispatch)
#   - Repository dispatch (from build-and-push workflow on release)
#
# Required Secrets:
#   - SERVER_HOST: Production server IP or hostname
#   - SERVER_USER: SSH user (default: root)
#   - SERVER_SSH_KEY: Private SSH key for authentication
#   - GHCR_TOKEN: GitHub PAT with read:packages scope (for server to pull images)
#

name: Deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Image tag to deploy'
        required: true
        default: 'latest'
        type: string
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

  repository_dispatch:
    types: [deploy]

env:
  REGISTRY: ghcr.io
  DEPLOY_PATH: /opt/opareta

permissions:
  contents: read

jobs:
  # ===========================================================================
  # Deploy to Server
  # ===========================================================================
  deploy:
    name: Deploy to ${{ inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine image tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "repository_dispatch" ]; then
            echo "tag=${{ github.event.client_payload.tag }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ inputs.tag }}" >> $GITHUB_OUTPUT
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} \
            "echo 'SSH connection successful'"

      - name: Sync infrastructure files
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.env' \
            --exclude '*.pem' \
            --exclude '.server-config' \
            ./infrastructure/ \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }}:${{ env.DEPLOY_PATH }}/infrastructure/

      - name: Deploy to server
        env:
          IMAGE_TAG: ${{ steps.tag.outputs.tag }}
          DOCKER_REGISTRY: ${{ env.REGISTRY }}/${{ github.repository_owner }}/
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} << 'DEPLOY_SCRIPT'
          set -e

          echo "=========================================="
          echo "  Deploying Opareta"
          echo "  Tag: ${{ steps.tag.outputs.tag }}"
          echo "=========================================="

          cd ${{ env.DEPLOY_PATH }}/infrastructure

          # Update environment with new tag
          if [ -f .env ]; then
            sed -i "s|^IMAGE_TAG=.*|IMAGE_TAG=${{ steps.tag.outputs.tag }}|" .env
            sed -i "s|^DOCKER_REGISTRY=.*|DOCKER_REGISTRY=${{ env.REGISTRY }}/${{ github.repository_owner }}/|" .env
          fi

          # Login to GHCR
          echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

          # Export variables for docker compose
          export IMAGE_TAG="${{ steps.tag.outputs.tag }}"
          export DOCKER_REGISTRY="${{ env.REGISTRY }}/${{ github.repository_owner }}/"

          # Source other env vars
          set -a
          source .env
          set +a

          # Run deployment script
          chmod +x deploy/deploy.sh
          ./deploy/deploy.sh "${{ steps.tag.outputs.tag }}"

          echo "=========================================="
          echo "  Deployment completed!"
          echo "=========================================="
          DEPLOY_SCRIPT

      - name: Verify deployment
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SERVER_USER || 'root' }}@${{ secrets.SERVER_HOST }} << 'VERIFY_SCRIPT'
          set -e

          echo "Verifying deployment..."

          cd ${{ env.DEPLOY_PATH }}/infrastructure

          # Check service status
          docker compose -f docker/docker-compose.prod.yml ps

          # Health checks
          echo ""
          echo "Health checks:"

          for port in 3001 3002 3003 3004; do
            if curl -sf http://localhost:$port/api/health > /dev/null 2>&1; then
              echo "  ✓ Port $port: healthy"
            else
              echo "  ✗ Port $port: unhealthy"
            fi
          done
          VERIFY_SCRIPT

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Deployment failed! Check logs for details."

  # ===========================================================================
  # Post-deployment notification
  # ===========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Create deployment summary
        run: |
          if [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Environment:** ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
            echo "**Image Tag:** ${{ inputs.tag || github.event.client_payload.tag }}" >> $GITHUB_STEP_SUMMARY
            echo "**Deployed at:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
